
# ============================================================================
# Makefile - CD4ML Production Project
# ============================================================================
# Comandos Ãºteis para desenvolvimento, testes e deploy
#
# Por que Makefile:
#   âœ… PadronizaÃ§Ã£o: Todos usam mesmos comandos
#   âœ… DocumentaÃ§Ã£o: Lista de comandos disponÃ­veis (make help)
#   âœ… Produtividade: Comandos longos viram "make test"
#   âœ… Onboarding: Novos devs aprendem rÃ¡pido
#
# Uso:
#   make help          # Ver todos os comandos
#   make test          # Rodar testes
#   make train         # Treinar modelo
#   make docker-build  # Build Docker image
#
# ConvenÃ§Ãµes:
#   - Targets em lowercase com hÃ­fens (test-data, docker-build)
#   - Cores ANSI para output legÃ­vel
#   - .PHONY para targets que nÃ£o criam arquivos
# ============================================================================

# ConfiguraÃ§Ãµes
.DEFAULT_GOAL := help
SHELL := /bin/bash
PYTHON := python
PIP := pip
PYTEST := pytest
DOCKER := docker
DOCKER_COMPOSE := docker-compose

# VariÃ¡veis de configuraÃ§Ã£o
PROJECT_NAME := cd4ml-wine-quality
DOCKER_IMAGE := $(PROJECT_NAME):latest
DOCKER_IMAGE_TEST := $(PROJECT_NAME):test

# Cores para output (ANSI)
COLOR_RESET := \033[0m
COLOR_BOLD := \033[1m
COLOR_GREEN := \033[32m
COLOR_YELLOW := \033[33m
COLOR_BLUE := \033[34m
COLOR_CYAN := \033[36m

# ============================================================================
# HELP - Lista de comandos disponÃ­veis
# ============================================================================
.PHONY: help
help: ## ğŸ“š Mostra esta mensagem de ajuda
	@echo ""
	@echo "$(COLOR_BOLD)$(COLOR_CYAN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(COLOR_RESET)"
	@echo "$(COLOR_BOLD)$(COLOR_CYAN)  ğŸš€ CD4ML Production Project - Makefile Commands$(COLOR_RESET)"
	@echo "$(COLOR_BOLD)$(COLOR_CYAN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(COLOR_RESET)"
	@echo ""
	@echo "$(COLOR_BOLD)Uso:$(COLOR_RESET) make $(COLOR_GREEN)<comando>$(COLOR_RESET)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(COLOR_GREEN)%-20s$(COLOR_RESET) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(COLOR_BOLD)Exemplos:$(COLOR_RESET)"
	@echo "  make setup           # Setup inicial do projeto"
	@echo "  make test            # Rodar todos os testes"
	@echo "  make train           # Treinar modelo"
	@echo "  make docker-build    # Build Docker image"
	@echo ""

# ============================================================================
# SETUP - ConfiguraÃ§Ã£o inicial do projeto
# ============================================================================
.PHONY: setup
setup: ## ğŸ”§ Setup inicial (venv + deps + data)
	@echo "$(COLOR_BOLD)$(COLOR_BLUE)ğŸ”§ Setting up project...$(COLOR_RESET)"
	@$(MAKE) venv
	@$(MAKE) install
	@$(MAKE) data-download
	@echo "$(COLOR_GREEN)âœ… Setup completed!$(COLOR_RESET)"

.PHONY: venv
venv: ## ğŸ Criar virtual environment
	@echo "$(COLOR_BLUE)Creating virtual environment...$(COLOR_RESET)"
	@python -m venv venv
	@echo "$(COLOR_GREEN)âœ… Virtual environment created!$(COLOR_RESET)"
	@echo "$(COLOR_YELLOW)ğŸ’¡ Activate with: source venv/bin/activate$(COLOR_RESET)"

.PHONY: install
install: ## ğŸ“¦ Instalar dependÃªncias
	@echo "$(COLOR_BLUE)Installing dependencies...$(COLOR_RESET)"
	@$(PIP) install --upgrade pip
	@$(PIP) install -r requirements.txt
	@echo "$(COLOR_GREEN)âœ… Dependencies installed!$(COLOR_RESET)"

.PHONY: install-dev
install-dev: ## ğŸ“¦ Instalar deps de desenvolvimento
	@echo "$(COLOR_BLUE)Installing dev dependencies...$(COLOR_RESET)"
	@$(PIP) install -r requirements-dev.txt || $(PIP) install pytest pytest-cov black flake8 mypy
	@echo "$(COLOR_GREEN)âœ… Dev dependencies installed!$(COLOR_RESET)"

# ============================================================================
# DATA - Gerenciamento de dados
# ============================================================================
.PHONY: data-download
data-download: ## ğŸ“¥ Baixar dataset
	@echo "$(COLOR_BLUE)Downloading dataset...$(COLOR_RESET)"
	@$(PYTHON) src/data/download_data.py
	@echo "$(COLOR_GREEN)âœ… Dataset downloaded!$(COLOR_RESET)"

.PHONY: data-prepare
data-prepare: ## ğŸ”§ Preparar dados (ETL)
	@echo "$(COLOR_BLUE)Running ETL pipeline...$(COLOR_RESET)"
	@$(PYTHON) src/data/make_dataset.py
	@echo "$(COLOR_GREEN)âœ… Data prepared!$(COLOR_RESET)"

.PHONY: data-validate
data-validate: ## âœ… Validar qualidade dos dados
	@echo "$(COLOR_BLUE)Validating data quality...$(COLOR_RESET)"
	@$(PYTEST) src/tests/test_data_quality.py -v
	@echo "$(COLOR_GREEN)âœ… Data validation passed!$(COLOR_RESET)"

# ============================================================================
# TESTES - Executar diferentes tipos de testes
# ============================================================================
.PHONY: test
test: ## ğŸ§ª Rodar TODOS os testes
	@echo "$(COLOR_BOLD)$(COLOR_BLUE)ğŸ§ª Running all tests...$(COLOR_RESET)"
	@$(PYTEST) src/tests/ -v --tb=short
	@echo "$(COLOR_GREEN)âœ… All tests passed!$(COLOR_RESET)"

.PHONY: test-data
test-data: ## ğŸ§ª Rodar testes de dados
	@echo "$(COLOR_BLUE)Running data quality tests...$(COLOR_RESET)"
	@$(PYTEST) src/tests/test_data_quality.py -v --tb=short
	@echo "$(COLOR_GREEN)âœ… Data tests passed!$(COLOR_RESET)"

.PHONY: test-model
test-model: ## ğŸ§ª Rodar testes de modelo
	@echo "$(COLOR_BLUE)Running model tests...$(COLOR_RESET)"
	@$(PYTEST) src/tests/test_model_metrics.py -v --tb=short
	@echo "$(COLOR_GREEN)âœ… Model tests passed!$(COLOR_RESET)"

.PHONY: test-inference
test-inference: ## ğŸ§ª Rodar testes de inferÃªncia
	@echo "$(COLOR_BLUE)Running inference tests...$(COLOR_RESET)"
	@$(PYTEST) src/tests/test_inference.py -v --tb=short
	@echo "$(COLOR_GREEN)âœ… Inference tests passed!$(COLOR_RESET)"

.PHONY: test-cov
test-cov: ## ğŸ“Š Rodar testes com coverage
	@echo "$(COLOR_BLUE)Running tests with coverage...$(COLOR_RESET)"
	@$(PYTEST) src/tests/ -v --cov=src --cov-report=html --cov-report=term
	@echo "$(COLOR_GREEN)âœ… Coverage report generated!$(COLOR_RESET)"
	@echo "$(COLOR_YELLOW)ğŸ’¡ Open htmlcov/index.html to view report$(COLOR_RESET)"

.PHONY: test-watch
test-watch: ## ğŸ‘€ Rodar testes em modo watch
	@echo "$(COLOR_BLUE)Running tests in watch mode...$(COLOR_RESET)"
	@$(PYTEST) src/tests/ -v --tb=short -f

# ============================================================================
# TREINO - Pipeline de treinamento
# ============================================================================
.PHONY: train
train: ## ğŸ“ Treinar modelo
	@echo "$(COLOR_BOLD)$(COLOR_BLUE)ğŸ“ Training model...$(COLOR_RESET)"
	@$(PYTHON) src/models/train.py
	@echo "$(COLOR_GREEN)âœ… Model trained!$(COLOR_RESET)"
	@$(MAKE) test-model

.PHONY: predict
predict: ## ğŸ”® Fazer prediÃ§Ãµes (exemplo)
	@echo "$(COLOR_BLUE)Running prediction example...$(COLOR_RESET)"
	@$(PYTHON) src/models/predict.py
	@echo "$(COLOR_GREEN)âœ… Prediction completed!$(COLOR_RESET)"

.PHONY: experiments
experiments: ## ğŸ“Š Abrir MLflow UI
	@echo "$(COLOR_BLUE)Starting MLflow UI...$(COLOR_RESET)"
	@echo "$(COLOR_YELLOW)ğŸ’¡ Access at: http://localhost:5000$(COLOR_RESET)"
	@mlflow ui

# ============================================================================
# DVC - Data Version Control
# ============================================================================
.PHONY: dvc-init
dvc-init: ## ğŸ”§ Inicializar DVC
	@echo "$(COLOR_BLUE)Initializing DVC...$(COLOR_RESET)"
	@dvc init --subdir
	@dvc config core.autostage true
	@echo "$(COLOR_GREEN)âœ… DVC initialized!$(COLOR_RESET)"

.PHONY: dvc-repro
dvc-repro: ## ğŸ”„ Reproduzir pipeline DVC
	@echo "$(COLOR_BLUE)Reproducing DVC pipeline...$(COLOR_RESET)"
	@dvc repro
	@echo "$(COLOR_GREEN)âœ… Pipeline reproduced!$(COLOR_RESET)"

.PHONY: dvc-dag
dvc-dag: ## ğŸ“Š Visualizar DAG do pipeline
	@echo "$(COLOR_BLUE)DVC Pipeline DAG:$(COLOR_RESET)"
	@dvc dag

.PHONY: dvc-metrics
dvc-metrics: ## ğŸ“ˆ Ver mÃ©tricas do pipeline
	@echo "$(COLOR_BLUE)DVC Metrics:$(COLOR_RESET)"
	@dvc metrics show

.PHONY: dvc-push
dvc-push: ## â¬†ï¸  Push artifacts para DVC remote
	@echo "$(COLOR_BLUE)Pushing to DVC remote...$(COLOR_RESET)"
	@dvc push
	@echo "$(COLOR_GREEN)âœ… Artifacts pushed!$(COLOR_RESET)"

.PHONY: dvc-pull
dvc-pull: ## â¬‡ï¸  Pull artifacts do DVC remote
	@echo "$(COLOR_BLUE)Pulling from DVC remote...$(COLOR_RESET)"
	@dvc pull
	@echo "$(COLOR_GREEN)âœ… Artifacts pulled!$(COLOR_RESET)"

# ============================================================================
# DOCKER - ContainerizaÃ§Ã£o
# ============================================================================
.PHONY: docker-build
docker-build: ## ğŸ³ Build Docker image
	@echo "$(COLOR_BOLD)$(COLOR_BLUE)ğŸ³ Building Docker image...$(COLOR_RESET)"
	@$(DOCKER) build -t $(DOCKER_IMAGE) .
	@echo "$(COLOR_GREEN)âœ… Docker image built: $(DOCKER_IMAGE)$(COLOR_RESET)"

.PHONY: docker-build-no-cache
docker-build-no-cache: ## ğŸ³ Build Docker sem cache
	@echo "$(COLOR_BLUE)Building Docker image (no cache)...$(COLOR_RESET)"
	@$(DOCKER) build --no-cache -t $(DOCKER_IMAGE) .
	@echo "$(COLOR_GREEN)âœ… Docker image built!$(COLOR_RESET)"

.PHONY: docker-test
docker-test: ## ğŸ§ª Rodar testes no Docker
	@echo "$(COLOR_BLUE)Running tests in Docker...$(COLOR_RESET)"
	@$(DOCKER) run --rm $(DOCKER_IMAGE) pytest src/tests/ -v
	@echo "$(COLOR_GREEN)âœ… Docker tests passed!$(COLOR_RESET)"

.PHONY: docker-train
docker-train: ## ğŸ“ Treinar modelo no Docker
	@echo "$(COLOR_BLUE)Training model in Docker...$(COLOR_RESET)"
	@$(DOCKER) run --rm -v $(PWD)/models:/app/models $(DOCKER_IMAGE) python src/models/train.py
	@echo "$(COLOR_GREEN)âœ… Model trained in Docker!$(COLOR_RESET)"

.PHONY: docker-shell
docker-shell: ## ğŸš Shell interativo no Docker
	@echo "$(COLOR_BLUE)Starting Docker shell...$(COLOR_RESET)"
	@$(DOCKER) run --rm -it $(DOCKER_IMAGE) /bin/bash

.PHONY: docker-mlflow
docker-mlflow: ## ğŸ“Š MLflow UI no Docker
	@echo "$(COLOR_BLUE)Starting MLflow UI in Docker...$(COLOR_RESET)"
	@echo "$(COLOR_YELLOW)ğŸ’¡ Access at: http://localhost:5000$(COLOR_RESET)"
	@$(DOCKER) run --rm -p 5000:5000 -v $(PWD)/mlruns:/app/mlruns $(DOCKER_IMAGE) mlflow ui --host 0.0.0.0

.PHONY: docker-clean
docker-clean: ## ğŸ§¹ Limpar imagens Docker
	@echo "$(COLOR_BLUE)Cleaning Docker images...$(COLOR_RESET)"
	@$(DOCKER) rmi $(DOCKER_IMAGE) 2>/dev/null || true
	@$(DOCKER) rmi $(DOCKER_IMAGE_TEST) 2>/dev/null || true
	@$(DOCKER) system prune -f
	@echo "$(COLOR_GREEN)âœ… Docker images cleaned!$(COLOR_RESET)"

# ============================================================================
# DOCKER COMPOSE - OrquestraÃ§Ã£o
# ============================================================================
.PHONY: compose-up
compose-up: ## ğŸ™ Iniciar serviÃ§os (docker-compose)
	@echo "$(COLOR_BLUE)Starting services with docker-compose...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) up -d
	@echo "$(COLOR_GREEN)âœ… Services started!$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) ps

.PHONY: compose-down
compose-down: ## ğŸ™ Parar serviÃ§os (docker-compose)
	@echo "$(COLOR_BLUE)Stopping services...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) down
	@echo "$(COLOR_GREEN)âœ… Services stopped!$(COLOR_RESET)"

.PHONY: compose-logs
compose-logs: ## ğŸ“‹ Ver logs (docker-compose)
	@$(DOCKER_COMPOSE) logs -f

.PHONY: compose-build
compose-build: ## ğŸ”¨ Rebuild serviÃ§os (docker-compose)
	@echo "$(COLOR_BLUE)Rebuilding services...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) build
	@echo "$(COLOR_GREEN)âœ… Services rebuilt!$(COLOR_RESET)"

# ============================================================================
# CODE QUALITY - Linters e formataÃ§Ã£o
# ============================================================================
.PHONY: lint
lint: ## ğŸ” Rodar linters (flake8)
	@echo "$(COLOR_BLUE)Running linters...$(COLOR_RESET)"
	@flake8 src/ --max-line-length=100 --exclude=venv,__pycache__
	@echo "$(COLOR_GREEN)âœ… Linting passed!$(COLOR_RESET)"

.PHONY: format
format: ## âœ¨ Formatar cÃ³digo (black)
	@echo "$(COLOR_BLUE)Formatting code...$(COLOR_RESET)"
	@black src/ --line-length=100
	@echo "$(COLOR_GREEN)âœ… Code formatted!$(COLOR_RESET)"

.PHONY: format-check
format-check: ## âœ… Verificar formataÃ§Ã£o
	@echo "$(COLOR_BLUE)Checking code format...$(COLOR_RESET)"
	@black src/ --check --line-length=100
	@echo "$(COLOR_GREEN)âœ… Format check passed!$(COLOR_RESET)"

.PHONY: type-check
type-check: ## ğŸ” Type checking (mypy)
	@echo "$(COLOR_BLUE)Running type checker...$(COLOR_RESET)"
	@mypy src/ --ignore-missing-imports
	@echo "$(COLOR_GREEN)âœ… Type checking passed!$(COLOR_RESET)"

.PHONY: quality
quality: format lint type-check ## âœ¨ Rodar todos os checks de qualidade
	@echo "$(COLOR_GREEN)âœ… All quality checks passed!$(COLOR_RESET)"

# ============================================================================
# LIMPEZA - Remover arquivos temporÃ¡rios
# ============================================================================
.PHONY: clean
clean: ## ğŸ§¹ Limpar cache e arquivos temporÃ¡rios
	@echo "$(COLOR_BLUE)Cleaning temporary files...$(COLOR_RESET)"
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@find . -type f -name ".coverage" -delete 2>/dev/null || true
	@rm -rf htmlcov/ .tox/ dist/ build/ 2>/dev/null || true
	@echo "$(COLOR_GREEN)âœ… Cleanup completed!$(COLOR_RESET)"

.PHONY: clean-data
clean-data: ## ğŸ§¹ Limpar dados (CUIDADO!)
	@echo "$(COLOR_YELLOW)âš ï¸  This will delete all data files!$(COLOR_RESET)"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		rm -rf data/raw/* data/processed/* models/*.pkl models/*.json; \
		echo "$(COLOR_GREEN)âœ… Data cleaned!$(COLOR_RESET)"; \
	else \
		echo "$(COLOR_YELLOW)Cancelled.$(COLOR_RESET)"; \
	fi

.PHONY: clean-all
clean-all: clean clean-data docker-clean ## ğŸ§¹ Limpeza completa (cÃ³digo + data + docker)
	@echo "$(COLOR_GREEN)âœ… Complete cleanup finished!$(COLOR_RESET)"

# ============================================================================
# GIT - Comandos Ãºteis de Git
# ============================================================================
.PHONY: git-status
git-status: ## ğŸ“Š Git status formatado
	@echo "$(COLOR_BLUE)Git Status:$(COLOR_RESET)"
	@git status -sb

.PHONY: git-log
git-log: ## ğŸ“œ Git log formatado
	@git log --oneline --graph --decorate --all -10

.PHONY: git-diff
git-diff: ## ğŸ“Š Git diff
	@git diff

# ============================================================================
# CI/CD - Simular pipeline CI/CD localmente
# ============================================================================
.PHONY: ci
ci: ## ğŸš€ Simular CI/CD localmente
	@echo "$(COLOR_BOLD)$(COLOR_BLUE)ğŸš€ Running CI/CD pipeline locally...$(COLOR_RESET)"
	@echo ""
	@echo "$(COLOR_BOLD)Step 1/4: Data Quality Tests$(COLOR_RESET)"
	@$(MAKE) test-data
	@echo ""
	@echo "$(COLOR_BOLD)Step 2/4: Train Model$(COLOR_RESET)"
	@$(MAKE) train
	@echo ""
	@echo "$(COLOR_BOLD)Step 3/4: Model Tests$(COLOR_RESET)"
	@$(MAKE) test-model
	@echo ""
	@echo "$(COLOR_BOLD)Step 4/4: Inference Tests$(COLOR_RESET)"
	@$(MAKE) test-inference
	@echo ""
	@echo "$(COLOR_GREEN)$(COLOR_BOLD)âœ… CI/CD pipeline completed successfully!$(COLOR_RESET)"

.PHONY: ci-docker
ci-docker: ## ğŸš€ Simular CI/CD no Docker
	@echo "$(COLOR_BOLD)$(COLOR_BLUE)ğŸš€ Running CI/CD in Docker...$(COLOR_RESET)"
	@$(MAKE) docker-build
	@$(MAKE) docker-test
	@$(MAKE) docker-train
	@echo "$(COLOR_GREEN)$(COLOR_BOLD)âœ… Docker CI/CD completed!$(COLOR_RESET)"

# ============================================================================
# UTILITÃRIOS - Comandos de diagnÃ³stico
# ============================================================================
.PHONY: info
info: ## â„¹ï¸  Mostrar informaÃ§Ãµes do projeto
	@echo "$(COLOR_BOLD)$(COLOR_CYAN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(COLOR_RESET)"
	@echo "$(COLOR_BOLD)  ğŸ“Š Project Information$(COLOR_RESET)"
	@echo "$(COLOR_BOLD)$(COLOR_CYAN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(COLOR_RESET)"
	@echo ""
	@echo "$(COLOR_BOLD)Project:$(COLOR_RESET)       $(PROJECT_NAME)"
	@echo "$(COLOR_BOLD)Python:$(COLOR_RESET)        $$(python --version 2>&1)"
	@echo "$(COLOR_BOLD)Pip:$(COLOR_RESET)           $$(pip --version 2>&1 | cut -d' ' -f1-2)"
	@echo "$(COLOR_BOLD)Pytest:$(COLOR_RESET)        $$(pytest --version 2>&1 | head -1)"
	@echo "$(COLOR_BOLD)DVC:$(COLOR_RESET)           $$(dvc version 2>&1 | head -1)"
	@echo "$(COLOR_BOLD)Docker:$(COLOR_RESET)        $$(docker --version 2>&1)"
	@echo "$(COLOR_BOLD)Git Branch:$(COLOR_RESET)    $$(git branch --show-current 2>&1)"
	@echo "$(COLOR_BOLD)Git Commit:$(COLOR_RESET)    $$(git rev-parse --short HEAD 2>&1)"
	@echo ""
	@echo "$(COLOR_BOLD)Files:$(COLOR_RESET)"
	@echo "  Data:   $$(find data -type f 2>/dev/null | wc -l) files"
	@echo "  Models: $$(find models -type f 2>/dev/null | wc -l) files"
	@echo "  Tests:  $$(find src/tests -name 'test_*.py' 2>/dev/null | wc -l) files"
	@echo ""

.PHONY: check-deps
check-deps: ## âœ… Verificar dependÃªncias instaladas
	@echo "$(COLOR_BLUE)Checking dependencies...$(COLOR_RESET)"
	@$(PYTHON) -c "import pandas; import numpy; import sklearn; import mlflow; import dvc; import pytest; print('$(COLOR_GREEN)âœ… All core dependencies installed!$(COLOR_RESET)')"

.PHONY: tree
tree: ## ğŸŒ² Mostrar estrutura do projeto
	@echo "$(COLOR_BLUE)Project Structure:$(COLOR_RESET)"
	@tree -L 3 -I 'venv|__pycache__|*.pyc|.git|.dvc/cache|mlruns' || ls -R | grep ":$$" | sed -e 's/:$$//' -e 's/[^-][^\/]*\//--/g' -e 's/^/   /' -e 's/-/|/'


# ============================================================================
# API - FastAPI
# ============================================================================
.PHONY: api
api: ## ğŸš€ Iniciar API (dev mode com reload)
	@echo "$(COLOR_BOLD)$(COLOR_BLUE)ğŸš€ Starting FastAPI...$(COLOR_RESET)"
	@echo "$(COLOR_YELLOW)ğŸ’¡ API: http://localhost:8000$(COLOR_RESET)"
	@echo "$(COLOR_YELLOW)ğŸ’¡ Docs: http://localhost:8000/docs$(COLOR_RESET)"
	@python run_api.py

.PHONY: api-prod
api-prod: ## ğŸš€ Iniciar API (production mode)
	@echo "$(COLOR_BLUE)Starting API (production)...$(COLOR_RESET)"
	@uvicorn api.main:app --host 0.0.0.0 --port 8000 --workers 4

.PHONY: api-test
api-test: ## ğŸ§ª Testar API
	@echo "$(COLOR_BLUE)Testing API...$(COLOR_RESET)"
	@pytest api/tests/ -v --tb=short

.PHONY: api-docs
api-docs: ## ğŸ“š Abrir documentaÃ§Ã£o da API
	@echo "$(COLOR_BLUE)Opening API docs...$(COLOR_RESET)"
	@python -m webbrowser http://localhost:8000/docs

# ============================================================================
# API TESTS - Testes da API
# ============================================================================
.PHONY: test-api
test-api: ## ğŸ§ª Rodar testes da API
	@echo "$(COLOR_BLUE)Running API tests...$(COLOR_RESET)"
	@$(PYTEST) api/tests/ -v --tb=short
	@echo "$(COLOR_GREEN)âœ… API tests passed!$(COLOR_RESET)"

.PHONY: test-api-unit
test-api-unit: ## ğŸ§ª Rodar apenas testes unitÃ¡rios da API
	@echo "$(COLOR_BLUE)Running API unit tests...$(COLOR_RESET)"
	@$(PYTEST) api/tests/test_endpoints.py api/tests/test_validation.py -v

.PHONY: test-api-integration
test-api-integration: ## ğŸ§ª Rodar testes de integraÃ§Ã£o da API
	@echo "$(COLOR_BLUE)Running API integration tests...$(COLOR_RESET)"
	@$(PYTEST) api/tests/test_integration.py -v

.PHONY: test-api-performance
test-api-performance: ## ğŸ§ª Rodar testes de performance da API
	@echo "$(COLOR_BLUE)Running API performance tests...$(COLOR_RESET)"
	@$(PYTEST) api/tests/test_performance.py -v

.PHONY: test-api-cov
test-api-cov: ## ğŸ“Š Rodar testes da API com coverage
	@echo "$(COLOR_BLUE)Running API tests with coverage...$(COLOR_RESET)"
	@$(PYTEST) api/tests/ -v --cov=api --cov-report=html --cov-report=term
	@echo "$(COLOR_GREEN)âœ… Coverage report generated!$(COLOR_RESET)"
	@echo "$(COLOR_YELLOW)ğŸ’¡ Open htmlcov/index.html$(COLOR_RESET)"

.PHONY: test-all
test-all: ## ğŸ§ª Rodar TODOS os testes (src + api)
	@echo "$(COLOR_BOLD)$(COLOR_BLUE)ğŸ§ª Running ALL tests...$(COLOR_RESET)"
	@$(PYTEST) src/tests/ api/tests/ -v --tb=short
	@echo "$(COLOR_GREEN)$(COLOR_BOLD)âœ… All tests passed!$(COLOR_RESET)"
	
# ============================================================================
# DOCUMENTAÃ‡ÃƒO - Gerar documentaÃ§Ã£o
# ============================================================================
.PHONY: docs
docs: ## ğŸ“š Gerar documentaÃ§Ã£o (futuro)
	@echo "$(COLOR_YELLOW)ğŸ“š Documentation generation not yet implemented$(COLOR_RESET)"
	@echo "$(COLOR_YELLOW)ğŸ’¡ Future: Sphinx or MkDocs$(COLOR_RESET)"

# ============================================================================
# BENCHMARKS - Testes de performance
# ============================================================================
.PHONY: benchmark
benchmark: ## âš¡ Benchmark de inferÃªncia
	@echo "$(COLOR_BLUE)Running inference benchmark...$(COLOR_RESET)"
	@$(PYTHON) -m timeit -n 1000 -s "from src.models.predict import WineQualityPredictor; p = WineQualityPredictor(); sample = {'fixed_acidity': 7.4, 'volatile_acidity': 0.7, 'citric_acid': 0.0, 'residual_sugar': 1.9, 'chlorides': 0.076, 'free_sulfur_dioxide': 11.0, 'total_sulfur_dioxide': 34.0, 'density': 0.9978, 'pH': 3.51, 'sulphates': 0.56, 'alcohol': 9.4}" "p.predict(sample)"
	@echo "$(COLOR_GREEN)âœ… Benchmark completed!$(COLOR_RESET)"

# ============================================================================
# ATALHOS - Aliases comuns
# ============================================================================
.PHONY: t
t: test ## Alias para 'make test'

.PHONY: r
r: train ## Alias para 'make train'

.PHONY: d
d: docker-build ## Alias para 'make docker-build'

# ============================================================================
# NOTAS
# ============================================================================
# - Todos os targets com .PHONY nÃ£o criam arquivos
# - Cores ANSI funcionam em Linux/Mac (Windows WSL tambÃ©m)
# - Para desabilitar cores: make <target> 2>&1 | cat
# - Para debug: make -n <target> (dry-run)
# ============================================================================

